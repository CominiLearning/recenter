(()=>{"use strict";var e=function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function r(e){try{a(o.next(e))}catch(e){n(e)}}function l(e){try{a(o.throw(e))}catch(e){n(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,l)}a((o=o.apply(e,t||[])).next())}))};function t(t,i){return e(this,void 0,void 0,(function*(){try{const e={model:"gpt-3.5-turbo-0125",response_format:{type:"json_object"},messages:[{role:"user",content:`Imagine you're a digital detective tasked with classifying websites as either 'wasteful,' 'productive,' or 'unsure.' You're given a website URL, and you must determine its classification based on whether it helps with work, is used to kill time, or is ambiguous in its purpose. For the purpose of this task, 'work' is defined as any activity that contributes to one's professional or educational goals, such as research, learning, collaboration, or productivity tools. Your output should be a JSON object containing the classification, the URL. For example, if the website is Netflix.com and the description is your response might be: {'CLASSIFICATION': 'Wasteful', 'URL': 'netflix.com'}. Now, classify ${t}\n      `}]},o=yield fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i.authKey}`},body:JSON.stringify(e)}),s=(yield o.json()).choices[0].message.content;return JSON.parse(s)}catch(e){return console.log(e),{}}}))}function i(){var i,o;return e(this,void 0,void 0,(function*(){try{const e=yield chrome.storage.local.get("authKey");if(!e.authKey)throw new Error("No API Key found");const s=yield chrome.storage.local.get("visitedURLs");if(!s.visitedURLs)throw new Error("No URLs found");const n=s.visitedURLs;if(0===n.length)return;const r=(null===(i=yield chrome.storage.local.get("preTaggedUrls"))||void 0===i?void 0:i.preTaggedUrls)||[],l=[];for(let i=0;i<n.length;i++){const s=n[i];let a="unsure";const c=r.find((e=>e.URL===s));if(c)a=c.CLASSIFICATION.toLowerCase();else{const i=yield t(s,e);a=null===(o=i.CLASSIFICATION)||void 0===o?void 0:o.toLowerCase()}let d=0;d="productive"===a?1:"unsure"===a?2:3,l.push({id:s,website:s,tag:d})}!function(e){var t,i,o,s;t=this,i=void 0,s=function*(){const t=(yield chrome.storage.local.get("taggedURLs")).taggedURLs||[],i=(yield chrome.storage.local.get("visitedURLs")).visitedURLs||[];for(let o=0;o<e.length;o++){for(let i=0;i<t.length;i++)t[i].website===e[o].website&&t.splice(i,1);i.includes(e[o].website)&&i.splice(i.indexOf(e[o].website),1),0!==e[o].tag?t.push(e[o]):i.push(e[o].website)}yield chrome.storage.local.set({taggedURLs:t}),yield chrome.storage.local.set({visitedURLs:i})},new((o=void 0)||(o=Promise))((function(e,n){function r(e){try{a(s.next(e))}catch(e){n(e)}}function l(e){try{a(s.throw(e))}catch(e){n(e)}}function a(t){var i;t.done?e(t.value):(i=t.value,i instanceof o?i:new o((function(e){e(i)}))).then(r,l)}a((s=s.apply(t,i||[])).next())}))}(l)}catch(e){console.error(e)}}))}class o{constructor(e){this.isExtensionDisabled=!0,this.interval=setInterval(this.keepTrack.bind(this),1e4),this.isExtensionDisabled=e}setExtensionDisabled(e){this.isExtensionDisabled=e}keepTrack(){this.isExtensionDisabled||chrome.storage.local.get(["webTime"],(e=>{return t=this,i=void 0,n=function*(){if(void 0===e.webTime)return;const t=e.webTime;for(let e=0;e<t.length;e++)if(t[e].time>3e4){const i=t[e].url;(yield o.checkIfURLVisited(i))||chrome.storage.local.get(["visitedURLs"],(e=>{const t=e.visitedURLs||[];t.push(i),chrome.storage.local.set({visitedURLs:t})}))}},new((s=void 0)||(s=Promise))((function(e,o){function r(e){try{a(n.next(e))}catch(e){o(e)}}function l(e){try{a(n.throw(e))}catch(e){o(e)}}function a(t){var i;t.done?e(t.value):(i=t.value,i instanceof s?i:new s((function(e){e(i)}))).then(r,l)}a((n=n.apply(t,i||[])).next())}));var t,i,s,n}))}clear(){clearInterval(this.interval)}static checkIfURLVisited(e){return new Promise((t=>{chrome.storage.local.get(["visitedURLs","taggedURLs"],(i=>{const o=i.visitedURLs||[],s=i.taggedURLs||[];t(o.includes(e)||s.some((t=>t.website===e)))}))}))}}var s=function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function r(e){try{a(o.next(e))}catch(e){n(e)}}function l(e){try{a(o.throw(e))}catch(e){n(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,l)}a((o=o.apply(e,t||[])).next())}))};class n{constructor(e,t){this.baseUrl="",chrome.tabs.query({active:!0,currentWindow:!0},(e=>{if(e&&e[0]&&e[0].url){if(!e[0].url||"chrome://newtab/"===e[0].url)return;const t=new URL(e[0].url).origin;""!==t&&(this.baseUrl=t)}})),this.startTime=Date.now(),this.interval=setInterval(this.measureTime.bind(this),1e3),this.isHidden=e,this.isDisabled=t}setWindowHidden(e){this.isHidden=e,e&&this.storeDailyTime().then((()=>{this.storeTime().then((()=>{this.startTime=Date.now()}))}))}setExtensionDisabled(e){this.isDisabled=e}setStartTime(e){this.startTime=e}getTimeSpent(){return Date.now()-this.startTime}storeTime(){var e;return s(this,void 0,void 0,(function*(){let t=((null===(e=yield chrome.storage.local.get("webTime"))||void 0===e?void 0:e.webTime)||[]).filter((e=>""!==e.url));for(let e=0;e<t.length;e++)if(t[e].url===this.baseUrl)return t[e].time+=this.getTimeSpent(),void(yield chrome.storage.local.set({webTime:t}));t.push({url:this.baseUrl,time:this.getTimeSpent()}),yield chrome.storage.local.set({webTime:t})}))}storeWeeklyTime(){var e;return s(this,void 0,void 0,(function*(){const t=(new Date).getDay(),i=(yield chrome.storage.local.get("dayToday")).dayToday||0;if(1===t&&t!==i)yield this.setNewWeek();else if(t!==i){yield chrome.storage.local.set({dayToday:t});const e=(yield chrome.storage.local.get("numberOfDaysInWeek")).numberOfDaysInWeek||0;yield chrome.storage.local.set({numberOfDaysInWeek:e+1})}let o=((null===(e=yield chrome.storage.local.get("weeklyTime"))||void 0===e?void 0:e.weeklyTime)||[]).filter((e=>""!==e.url));for(let e=0;e<o.length;e++)if(o[e].url===this.baseUrl)return o[e].time+=this.getTimeSpent(),void(yield chrome.storage.local.set({weeklyTime:o}));o.push({url:this.baseUrl,time:this.getTimeSpent()}),yield chrome.storage.local.set({weeklyTime:o})}))}storeMonthlyTime(){var e;return s(this,void 0,void 0,(function*(){(new Date).getMonth()!==((yield chrome.storage.local.get("monthToday")).monthToday||0)&&(yield this.setNewMonth());let t=((null===(e=yield chrome.storage.local.get("monthlyTime"))||void 0===e?void 0:e.monthlyTime)||[]).filter((e=>""!==e.url));for(let e=0;e<t.length;e++)if(t[e].url===this.baseUrl)return t[e].time+=this.getTimeSpent(),void(yield chrome.storage.local.set({monthlyTime:t}));t.push({url:this.baseUrl,time:this.getTimeSpent()}),yield chrome.storage.local.set({monthlyTime:t})}))}storeDailyTime(){var e,t;return s(this,void 0,void 0,(function*(){let i=((null===(e=yield chrome.storage.local.get("dailyTime"))||void 0===e?void 0:e.dailyTime)||[]).filter((e=>""!==e.url));const o=(new Date).toDateString();((null===(t=yield chrome.storage.local.get("today"))||void 0===t?void 0:t.today)||"")!==o&&(i=[],yield this.setNewDay());for(let e=0;e<i.length;e++)if(i[e].url===this.baseUrl)return i[e].time+=this.getTimeSpent(),void(yield chrome.storage.local.set({dailyTime:i}));i.push({url:this.baseUrl,time:this.getTimeSpent()}),yield chrome.storage.local.set({dailyTime:i})}))}measureTime(){this.isDisabled||""===this.baseUrl||this.isHidden?this.startTime=Date.now():chrome.tabs.query({active:!0,currentWindow:!0},(e=>{if(e&&e[0]&&e[0].url){if(!e[0].url||"chrome://newtab/"===e[0].url)return;const t=new URL(e[0].url).origin;t!==this.baseUrl&&""!==t?this.storeDailyTime().then((()=>{this.storeTime().then((()=>s(this,void 0,void 0,(function*(){yield this.storeWeeklyTime(),yield this.storeMonthlyTime(),this.baseUrl=t,this.startTime=Date.now()}))))})):this.isHidden||this.getTimeSpent()>3e4&&this.storeDailyTime().then((()=>{this.storeTime().then((()=>s(this,void 0,void 0,(function*(){yield this.storeWeeklyTime(),yield this.storeMonthlyTime(),this.startTime=Date.now()}))))}))}}))}setNewDay(){var e;return s(this,void 0,void 0,(function*(){const t=(new Date).toDateString();let i=(null===(e=yield chrome.storage.local.get("numberOfDays"))||void 0===e?void 0:e.numberOfDays)||0;yield chrome.storage.local.set({numberOfDays:i+1}),yield chrome.storage.local.set({today:t})}))}setNewWeek(){return s(this,void 0,void 0,(function*(){const e=(new Date).getDay();yield chrome.storage.local.set({numberOfDaysInWeek:1}),yield chrome.storage.local.set({dayToday:e}),yield chrome.storage.local.set({weeklyTime:[]})}))}setNewMonth(){return s(this,void 0,void 0,(function*(){const e=(new Date).getMonth();yield chrome.storage.local.set({numberOfDays:1}),yield chrome.storage.local.set({monthToday:e}),yield chrome.storage.local.set({monthlyTime:[]})}))}}var r=function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function r(e){try{a(o.next(e))}catch(e){n(e)}}function l(e){try{a(o.throw(e))}catch(e){n(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,l)}a((o=o.apply(e,t||[])).next())}))},l=!1,a=!0,c=[0,6].includes((new Date).getDay()),d=null,h=!1,u=null;function m(){return l||a}chrome.runtime.onMessage.addListener(((e,t,i)=>{"visibility_changed"===e.message&&(h=e.hidden,u&&u.setWindowHidden(h)),i({message:"received"})})),function(){r(this,void 0,void 0,(function*(){a=!!(yield chrome.storage.local.get("isDisabledOnWeekend")).isDisabledOnWeekend&&c,chrome.storage.local.get("isDisabled",(e=>{if(void 0===e)return chrome.storage.local.set({isDisabled:!1}),void(l=!1);l=e.isDisabled,d?d.setExtensionDisabled(m()):d=new o(m()),u?u.setExtensionDisabled(m()):u=new n(h,m())})),chrome.storage.onChanged.addListener((e=>r(this,void 0,void 0,(function*(){if(e.isDisabled&&(l=e.isDisabled.newValue,d?d.setExtensionDisabled(m()):d=new o(m()),u?u.setExtensionDisabled(m()):u=new n(h,m())),e.blockedURLs){const t=e.blockedURLs.newValue;0===t.length&&t.push("not_a_real_website_example.com"),function(e){chrome.declarativeNetRequest.getDynamicRules((t=>{const i=t.map((e=>e.id));chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:i,addRules:[{action:{type:chrome.declarativeNetRequest.RuleActionType.BLOCK},condition:{isUrlFilterCaseSensitive:!0,regexFilter:e.join("|"),resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME,chrome.declarativeNetRequest.ResourceType.SUB_FRAME]},id:1,priority:2}]})}))}(t)}e.isDisabledOnWeekend&&(a=e.isDisabledOnWeekend.newValue&&c)}))))}))}(),setInterval((function(){return r(this,void 0,void 0,(function*(){m()||(yield i())}))}),3e5),fetch("../data/funny_lines.json").then((e=>{e.json().then((e=>{chrome.storage.local.set({funnyLines:e})}))})),fetch("../data/tagged_urls.json").then((e=>{e.json().then((e=>{chrome.storage.local.set({preTaggedUrls:e})}))}))})();